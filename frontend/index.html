<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brand Ad Intelligence</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700&family=Instrument+Serif:ital@0;1&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #f8f9fc;
            --bg-card: #ffffff;
            --bg-elevated: #ffffff;
            --bg-subtle: #f1f3f9;
            --bg-hover: #e8ebf2;

            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-muted: #94a3b8;
            --text-inverse: #ffffff;

            --accent-primary: #2563eb;
            --accent-primary-hover: #1d4ed8;
            --accent-secondary: #06b6d4;
            --accent-success: #10b981;
            --accent-warning: #f59e0b;
            --accent-danger: #ef4444;

            --border-light: #e2e8f0;
            --border-medium: #cbd5e1;

            --shadow-sm: 0 1px 2px rgba(15, 23, 42, 0.04);
            --shadow-md: 0 4px 12px rgba(15, 23, 42, 0.08);
            --shadow-lg: 0 12px 40px rgba(15, 23, 42, 0.12);
            --shadow-glow: 0 0 0 3px rgba(37, 99, 235, 0.15);

            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 16px;
            --radius-xl: 24px;
            --radius-full: 9999px;

            --font-display: 'Instrument Serif', Georgia, serif;
            --font-body: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;

            --transition-fast: 0.15s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-smooth: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        html { scroll-behavior: smooth; }

        body {
            font-family: var(--font-body);
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* ═══════════════════════════════════════════════════════════
           LAYOUT & CONTAINER
        ═══════════════════════════════════════════════════════════ */
        .app-wrapper {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 0 24px;
            width: 100%;
        }

        /* ═══════════════════════════════════════════════════════════
           HEADER & NAVIGATION
        ═══════════════════════════════════════════════════════════ */
        .app-header {
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-light);
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(12px);
            background: rgba(255, 255, 255, 0.95);
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 0;
            gap: 24px;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .brand-icon {
            width: 42px;
            height: 42px;
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-md);
        }

        .brand-icon svg {
            width: 24px;
            height: 24px;
            color: white;
        }

        .brand-text {
            display: flex;
            flex-direction: column;
        }

        .brand-name {
            font-family: var(--font-display);
            font-size: 1.35rem;
            font-weight: 400;
            color: var(--text-primary);
            letter-spacing: -0.02em;
        }

        .brand-tagline {
            font-size: 0.75rem;
            color: var(--text-muted);
            letter-spacing: 0.03em;
            text-transform: uppercase;
            font-weight: 500;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(16, 185, 129, 0.1);
            border-radius: var(--radius-full);
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--accent-success);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: var(--accent-success);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
        }

        .country-select {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            background: var(--bg-subtle);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
            font-size: 0.9rem;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .country-select:hover {
            background: var(--bg-hover);
            border-color: var(--border-medium);
        }

        .country-select select {
            border: none;
            background: transparent;
            font-family: inherit;
            font-size: inherit;
            color: var(--text-primary);
            cursor: pointer;
            outline: none;
            padding-right: 4px;
        }

        .flag-icon {
            width: 22px;
            height: 16px;
            border-radius: 3px;
            object-fit: cover;
        }

        /* ═══════════════════════════════════════════════════════════
           MAIN CONTENT
        ═══════════════════════════════════════════════════════════ */
        .main-content {
            flex: 1;
            padding: 32px 0 64px;
        }

        /* ═══════════════════════════════════════════════════════════
           SEARCH SECTION
        ═══════════════════════════════════════════════════════════ */
        .search-section {
            margin-bottom: 32px;
        }

        .search-card {
            background: var(--bg-card);
            border-radius: var(--radius-xl);
            padding: 32px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-light);
        }

        .search-header {
            margin-bottom: 24px;
        }

        .search-title {
            font-family: var(--font-display);
            font-size: 1.75rem;
            font-weight: 400;
            color: var(--text-primary);
            margin-bottom: 6px;
        }

        .search-subtitle {
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        .search-form {
            display: flex;
            gap: 12px;
            align-items: stretch;
        }

        .search-input-wrapper {
            flex: 1;
            position: relative;
        }

        .search-icon {
            position: absolute;
            left: 18px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            color: var(--text-muted);
            pointer-events: none;
        }

        .search-input {
            width: 100%;
            padding: 16px 18px 16px 52px;
            font-size: 1rem;
            font-family: inherit;
            border: 2px solid var(--border-light);
            border-radius: var(--radius-lg);
            background: var(--bg-subtle);
            color: var(--text-primary);
            transition: var(--transition-fast);
        }

        .search-input:hover {
            border-color: var(--border-medium);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            background: var(--bg-card);
            box-shadow: var(--shadow-glow);
        }

        .search-input::placeholder {
            color: var(--text-muted);
        }

        .search-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 16px 28px;
            font-size: 0.95rem;
            font-weight: 600;
            font-family: inherit;
            background: var(--accent-primary);
            color: var(--text-inverse);
            border: none;
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: var(--transition-fast);
            white-space: nowrap;
        }

        .search-btn:hover:not(:disabled) {
            background: var(--accent-primary-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .search-btn:active:not(:disabled) {
            transform: translateY(0);
        }

        .search-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .search-btn svg {
            width: 18px;
            height: 18px;
        }

        /* ═══════════════════════════════════════════════════════════
           PAGE SELECTION
        ═══════════════════════════════════════════════════════════ */
        .page-selection {
            display: none;
            margin-bottom: 32px;
            animation: slideUp 0.4s ease;
        }

        .page-selection.visible {
            display: block;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(16px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .selection-card {
            background: var(--bg-card);
            border-radius: var(--radius-xl);
            padding: 28px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-light);
        }

        .selection-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-light);
        }

        .selection-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .selection-badge {
            font-size: 0.75rem;
            font-weight: 500;
            padding: 4px 10px;
            background: var(--bg-subtle);
            border-radius: var(--radius-full);
            color: var(--text-secondary);
        }

        .search-status-text {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .search-status-text.loading {
            color: var(--accent-warning);
        }

        .search-status-text.complete {
            color: var(--accent-success);
        }

        .page-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .page-option {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 18px 20px;
            background: var(--bg-subtle);
            border: 2px solid transparent;
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .page-option:hover {
            background: var(--bg-hover);
            border-color: var(--border-medium);
        }

        .page-option.selected {
            background: rgba(37, 99, 235, 0.06);
            border-color: var(--accent-primary);
        }

        .page-option.quick-result {
            border-left: 4px solid var(--accent-warning);
        }

        .page-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .page-name-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .page-info h3 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .match-badge {
            font-size: 0.7rem;
            font-weight: 600;
            padding: 3px 8px;
            border-radius: var(--radius-sm);
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        .match-badge.direct {
            background: rgba(37, 99, 235, 0.12);
            color: var(--accent-primary);
        }

        .match-badge.exact_name {
            background: rgba(16, 185, 129, 0.12);
            color: var(--accent-success);
        }

        .match-badge.domain_match {
            background: rgba(245, 158, 11, 0.12);
            color: var(--accent-warning);
        }

        .match-badge.keyword_match {
            background: var(--bg-hover);
            color: var(--text-secondary);
        }

        .quick-badge {
            font-size: 0.8rem;
        }

        .page-domain {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .page-id {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-family: 'SF Mono', 'Monaco', monospace;
        }

        .page-stats {
            text-align: right;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 2px;
        }

        .ad-count {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-primary);
            line-height: 1.2;
        }

        .ad-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.04em;
        }

        .page-reach {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .load-ads-btn {
            width: 100%;
            margin-top: 20px;
            padding: 16px 24px;
            font-size: 1rem;
            font-weight: 600;
            font-family: inherit;
            background: var(--accent-primary);
            color: var(--text-inverse);
            border: none;
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .load-ads-btn:hover:not(:disabled) {
            background: var(--accent-primary-hover);
            box-shadow: var(--shadow-md);
        }

        .load-ads-btn:disabled {
            background: var(--bg-hover);
            color: var(--text-muted);
            cursor: not-allowed;
        }

        /* ═══════════════════════════════════════════════════════════
           TABS NAVIGATION
        ═══════════════════════════════════════════════════════════ */
        .tabs-container {
            display: none;
            margin-bottom: 24px;
        }

        .tabs-container.visible {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .tabs-wrapper {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 6px;
            display: inline-flex;
            gap: 4px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-light);
        }

        .tab {
            padding: 12px 24px;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-secondary);
            background: transparent;
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: var(--transition-fast);
            font-family: inherit;
        }

        .tab:hover:not(.active) {
            color: var(--text-primary);
            background: var(--bg-subtle);
        }

        .tab.active {
            background: var(--accent-primary);
            color: var(--text-inverse);
            box-shadow: var(--shadow-sm);
        }

        /* ═══════════════════════════════════════════════════════════
           RESULTS SECTION
        ═══════════════════════════════════════════════════════════ */
        .results-section {
            display: none;
            animation: slideUp 0.4s ease;
        }

        .results-section.visible {
            display: block;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 32px;
        }

        @media (max-width: 900px) {
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 500px) {
            .stats-grid { grid-template-columns: 1fr; }
        }

        .stat-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 24px;
            border: 1px solid var(--border-light);
            box-shadow: var(--shadow-sm);
            transition: var(--transition-fast);
        }

        .stat-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .stat-label {
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1.2;
        }

        .stat-value.accent {
            color: var(--accent-primary);
        }

        .stat-change {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 0.8rem;
            font-weight: 500;
            margin-top: 8px;
            padding: 4px 8px;
            border-radius: var(--radius-sm);
        }

        .stat-change.positive {
            background: rgba(16, 185, 129, 0.1);
            color: var(--accent-success);
        }

        /* Content Cards */
        .content-card {
            background: var(--bg-card);
            border-radius: var(--radius-xl);
            border: 1px solid var(--border-light);
            box-shadow: var(--shadow-sm);
            overflow: hidden;
            margin-bottom: 24px;
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-light);
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-title-icon {
            width: 32px;
            height: 32px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .card-title-icon.blue {
            background: rgba(37, 99, 235, 0.1);
            color: var(--accent-primary);
        }

        .card-title-icon.green {
            background: rgba(16, 185, 129, 0.1);
            color: var(--accent-success);
        }

        .card-title-icon.orange {
            background: rgba(245, 158, 11, 0.1);
            color: var(--accent-warning);
        }

        .card-title-icon svg {
            width: 18px;
            height: 18px;
        }

        .card-action {
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--accent-primary);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: var(--transition-fast);
        }

        .card-action:hover {
            gap: 8px;
        }

        .card-body {
            padding: 20px 24px;
        }

        /* Domains List */
        .domains-list {
            display: flex;
            flex-direction: column;
        }

        .domain-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 0;
            border-bottom: 1px solid var(--border-light);
        }

        .domain-item:last-child {
            border-bottom: none;
        }

        .domain-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .domain-icon {
            width: 36px;
            height: 36px;
            background: var(--bg-subtle);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }

        .domain-name {
            font-weight: 500;
            color: var(--text-primary);
        }

        .domain-name a {
            color: inherit;
            text-decoration: none;
            transition: var(--transition-fast);
        }

        .domain-name a:hover {
            color: var(--accent-primary);
        }

        .domain-badge {
            font-size: 0.75rem;
            font-weight: 500;
            padding: 5px 12px;
            border-radius: var(--radius-full);
            background: var(--bg-subtle);
            color: var(--text-secondary);
        }

        /* Ad Cards */
        .ads-grid {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .ad-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-light);
            padding: 20px;
            transition: var(--transition-fast);
        }

        .ad-card:hover {
            box-shadow: var(--shadow-md);
            border-color: var(--border-medium);
        }

        .ad-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: 14px;
        }

        .ad-page-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .ad-page-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 1rem;
        }

        .ad-page-name {
            font-weight: 600;
            color: var(--text-primary);
        }

        .ad-page-date {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .ad-badges {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .ad-status {
            font-size: 0.75rem;
            font-weight: 600;
            padding: 5px 12px;
            border-radius: var(--radius-full);
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        .ad-status.active {
            background: rgba(16, 185, 129, 0.1);
            color: var(--accent-success);
        }

        .ad-status.inactive {
            background: var(--bg-subtle);
            color: var(--text-muted);
        }

        .reach-badge {
            font-size: 0.8rem;
            font-weight: 600;
            padding: 5px 12px;
            border-radius: var(--radius-full);
            background: rgba(37, 99, 235, 0.1);
            color: var(--accent-primary);
        }

        .ad-headline {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
            font-size: 1rem;
        }

        .ad-text {
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.6;
            margin-bottom: 14px;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .ad-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 16px;
        }

        .ad-meta-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .ad-meta-item svg {
            width: 14px;
            height: 14px;
        }

        .ad-links {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            padding-top: 16px;
            border-top: 1px solid var(--border-light);
        }

        .ad-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 10px 16px;
            font-size: 0.85rem;
            font-weight: 500;
            border-radius: var(--radius-md);
            text-decoration: none;
            transition: var(--transition-fast);
        }

        .ad-link.primary {
            background: var(--accent-primary);
            color: var(--text-inverse);
        }

        .ad-link.primary:hover {
            background: var(--accent-primary-hover);
        }

        .ad-link.secondary {
            background: var(--bg-subtle);
            color: var(--text-primary);
            border: 1px solid var(--border-light);
        }

        .ad-link.secondary:hover {
            background: var(--bg-hover);
            border-color: var(--border-medium);
        }

        .ad-link svg {
            width: 16px;
            height: 16px;
        }

        /* Loading State */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 80px 40px;
            text-align: center;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--border-light);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            color: var(--text-secondary);
            font-size: 1rem;
        }

        .loading-subtext {
            color: var(--text-muted);
            font-size: 0.85rem;
            margin-top: 6px;
        }

        /* Empty & Error States */
        .empty-state {
            text-align: center;
            padding: 80px 40px;
            color: var(--text-muted);
        }

        .empty-state-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 20px;
            background: var(--bg-subtle);
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
        }

        .empty-state-icon svg {
            width: 32px;
            height: 32px;
        }

        .empty-state-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .error-message {
            background: rgba(239, 68, 68, 0.08);
            border: 1px solid rgba(239, 68, 68, 0.2);
            border-radius: var(--radius-lg);
            padding: 24px;
            text-align: center;
            color: var(--accent-danger);
        }

        /* ═══════════════════════════════════════════════════════════
           THIRD PARTY TAB STYLES
        ═══════════════════════════════════════════════════════════ */
        .pages-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 32px;
        }

        @media (max-width: 768px) {
            .pages-grid { grid-template-columns: 1fr; }
        }

        .page-category {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-light);
            padding: 20px;
        }

        .category-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-light);
        }

        .category-icon {
            width: 28px;
            height: 28px;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .category-icon.official {
            background: rgba(16, 185, 129, 0.1);
            color: var(--accent-success);
        }

        .category-icon.third-party {
            background: rgba(245, 158, 11, 0.1);
            color: var(--accent-warning);
        }

        .category-icon svg {
            width: 16px;
            height: 16px;
        }

        .category-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .third-party-page-card {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 16px;
            background: var(--bg-subtle);
            border-radius: var(--radius-md);
            margin-bottom: 8px;
            border-left: 3px solid transparent;
            transition: var(--transition-fast);
        }

        .third-party-page-card:last-child {
            margin-bottom: 0;
        }

        .third-party-page-card:hover {
            background: var(--bg-hover);
        }

        .third-party-page-card.official {
            border-left-color: var(--accent-success);
        }

        .third-party-page-card.third-party {
            border-left-color: var(--accent-warning);
        }

        .tp-page-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .tp-page-name {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text-primary);
        }

        .tp-page-id {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-family: 'SF Mono', monospace;
        }

        .tp-ad-count {
            font-weight: 700;
            color: var(--accent-primary);
            font-size: 0.9rem;
        }

        /* Domain Chips */
        .domain-categories {
            display: grid;
            gap: 20px;
            margin-bottom: 32px;
        }

        .domain-category {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-light);
            padding: 20px;
        }

        .domain-category h4 {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 16px;
        }

        .domain-category h4 svg {
            width: 18px;
            height: 18px;
        }

        .domain-list-compact {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .domain-chip {
            display: inline-flex;
            align-items: center;
            padding: 8px 14px;
            border-radius: var(--radius-full);
            font-size: 0.85rem;
            font-weight: 500;
            text-decoration: none;
            transition: var(--transition-fast);
        }

        .domain-chip.presell {
            background: rgba(245, 158, 11, 0.1);
            color: #b45309;
        }

        .domain-chip.presell:hover {
            background: rgba(245, 158, 11, 0.2);
        }

        .domain-chip.shop {
            background: rgba(16, 185, 129, 0.1);
            color: #047857;
        }

        .domain-chip.shop:hover {
            background: rgba(16, 185, 129, 0.2);
        }

        .domain-chip.redirect {
            background: rgba(6, 182, 212, 0.1);
            color: #0e7490;
        }

        .domain-chip.redirect:hover {
            background: rgba(6, 182, 212, 0.2);
        }

        .domain-list-detailed {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .domain-item-block {
            background: var(--bg-subtle);
            border-radius: var(--radius-md);
            padding: 12px 16px;
        }

        .domain-item-block .domain-chip {
            margin-bottom: 0;
        }

        .domain-item-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }

        .domain-match-badge {
            font-size: 0.68rem;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: var(--radius-full);
            background: rgba(37, 99, 235, 0.08);
            color: var(--accent-primary);
            white-space: nowrap;
        }

        .domain-match-badge.brand {
            background: rgba(16, 185, 129, 0.1);
            color: #047857;
        }

        .domain-url-list {
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin-top: 6px;
            padding-left: 8px;
            border-left: 2px solid var(--border-light);
        }

        .domain-url-entry {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 4px 10px;
            border-radius: var(--radius-sm);
            text-decoration: none;
            font-size: 0.8rem;
            color: var(--text-secondary);
            transition: var(--transition-fast);
        }

        .domain-url-entry:hover {
            background: var(--bg-hover);
            color: var(--accent-primary);
        }

        .domain-url-entry .url-path {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 80%;
            font-family: 'SF Mono', 'Fira Code', monospace;
            font-size: 0.78rem;
        }

        .domain-url-entry .url-ad-count {
            flex-shrink: 0;
            font-size: 0.72rem;
            font-weight: 600;
            color: var(--text-muted);
            background: var(--bg-card);
            padding: 1px 8px;
            border-radius: var(--radius-full);
        }

        /* Presell Chains */
        .presell-chains-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .presell-chain-item {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-light);
            padding: 18px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
        }

        .chain-flow {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .chain-step {
            display: flex;
            flex-direction: column;
            gap: 4px;
            padding: 10px 14px;
            border-radius: var(--radius-md);
            border-left: 3px solid;
        }

        .presell-step {
            background: rgba(245, 158, 11, 0.08);
            border-left-color: var(--accent-warning);
        }

        .cta-step {
            background: rgba(37, 99, 235, 0.08);
            border-left-color: var(--accent-primary);
        }

        .shop-step {
            background: rgba(16, 185, 129, 0.08);
            border-left-color: var(--accent-success);
        }

        .step-label {
            font-size: 0.65rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .step-url {
            font-size: 0.85rem;
            color: var(--text-primary);
            text-decoration: none;
        }

        .step-url:hover {
            text-decoration: underline;
        }

        .shop-domain {
            color: var(--accent-success);
            font-weight: 600;
        }

        .chain-arrow {
            color: var(--text-muted);
            font-size: 1.2rem;
        }

        .confidence-badge {
            padding: 5px 12px;
            border-radius: var(--radius-full);
            font-size: 0.75rem;
            font-weight: 600;
            white-space: nowrap;
        }

        .confidence-badge.high {
            background: rgba(16, 185, 129, 0.1);
            color: var(--accent-success);
        }

        .confidence-badge.low {
            background: rgba(245, 158, 11, 0.1);
            color: var(--accent-warning);
        }

        /* Domain Analysis Grid */
        .domain-analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
        }

        .domain-analysis-card {
            background: var(--bg-subtle);
            border-radius: var(--radius-md);
            padding: 14px 16px;
            border-left: 3px solid transparent;
            transition: var(--transition-fast);
        }

        .domain-analysis-card:hover {
            background: var(--bg-hover);
        }

        .domain-analysis-card.presell { border-left-color: var(--accent-warning); }
        .domain-analysis-card.shop { border-left-color: var(--accent-success); }
        .domain-analysis-card.affiliate { border-left-color: var(--accent-primary); }
        .domain-analysis-card.redirect { border-left-color: var(--accent-danger); }

        .da-domain {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 8px;
            word-break: break-all;
        }

        .da-type {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .type-badge {
            font-size: 0.65rem;
            font-weight: 600;
            padding: 3px 8px;
            border-radius: var(--radius-sm);
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        .type-badge.presell { background: rgba(245, 158, 11, 0.15); color: #b45309; }
        .type-badge.shop { background: rgba(16, 185, 129, 0.15); color: #047857; }
        .type-badge.affiliate { background: rgba(37, 99, 235, 0.15); color: var(--accent-primary); }
        .type-badge.redirect { background: rgba(239, 68, 68, 0.15); color: var(--accent-danger); }

        .da-confidence {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* Landing Pages Table */
        .landing-pages-table {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-light);
            overflow: hidden;
        }

        .lp-header {
            display: grid;
            grid-template-columns: 1fr 100px 100px;
            padding: 14px 20px;
            background: var(--bg-subtle);
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            gap: 16px;
        }

        .lp-row {
            display: grid;
            grid-template-columns: 1fr 100px 100px;
            padding: 14px 20px;
            border-top: 1px solid var(--border-light);
            transition: var(--transition-fast);
            gap: 16px;
            align-items: center;
        }

        .lp-row:hover {
            background: var(--bg-subtle);
        }

        .lp-row.even {
            background: rgba(248, 249, 252, 0.5);
        }

        .lp-url {
            color: var(--accent-primary);
            text-decoration: none;
            font-size: 0.85rem;
            word-break: break-all;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .lp-url:hover {
            text-decoration: underline;
        }

        .lp-url-domain {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .lp-url-path {
            color: var(--text-muted);
            font-size: 0.78rem;
            font-family: 'SF Mono', 'Cascadia Code', monospace;
            max-width: 500px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .lp-count {
            font-weight: 700;
            color: var(--text-primary);
            font-size: 0.9rem;
            text-align: right;
        }

        .lp-type-badge {
            display: inline-flex;
            align-items: center;
            padding: 2px 8px;
            border-radius: var(--radius-full);
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        .lp-type-badge.shop {
            background: rgba(16, 185, 129, 0.1);
            color: #059669;
        }

        .lp-type-badge.presell {
            background: rgba(245, 158, 11, 0.1);
            color: #d97706;
        }

        .lp-type-badge.redirect {
            background: rgba(99, 102, 241, 0.1);
            color: #4f46e5;
        }

        /* ═══════════════════════════════════════════════════════════
           DISCOVERY UI
        ═══════════════════════════════════════════════════════════ */
        .discovery-start {
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-lg);
            padding: 40px;
            text-align: center;
        }

        .btn-discovery {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 28px;
            background: var(--accent-primary);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-fast);
            font-family: var(--font-body);
        }

        .btn-discovery:hover {
            background: var(--accent-primary-hover);
            box-shadow: var(--shadow-glow);
        }

        .btn-discovery-quick {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            background: var(--bg-subtle);
            color: var(--text-secondary);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition-fast);
            font-family: var(--font-body);
        }

        .btn-discovery-quick:hover {
            background: var(--bg-hover);
            border-color: var(--border-medium);
        }

        .brand-info-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 12px;
            padding: 14px 20px;
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
            margin-bottom: 20px;
        }

        .brand-info-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .brand-domain-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            font-weight: 500;
        }

        .brand-domain-link {
            font-weight: 600;
            color: var(--accent-primary);
            text-decoration: none;
            font-size: 0.95rem;
        }

        .brand-domain-link:hover {
            text-decoration: underline;
        }

        .platform-badge {
            display: inline-flex;
            padding: 2px 8px;
            border-radius: var(--radius-full);
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        .platform-badge.shopify {
            background: rgba(16, 185, 129, 0.1);
            color: #059669;
        }

        .platform-badge.woocommerce {
            background: rgba(139, 92, 246, 0.1);
            color: #7c3aed;
        }

        .brand-info-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .scan-stat {
            font-size: 0.78rem;
            color: var(--text-muted);
        }

        .cached-badge {
            font-size: 0.7rem;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: var(--radius-full);
            background: rgba(6, 182, 212, 0.1);
            color: var(--accent-secondary);
            text-transform: uppercase;
        }

        .keywords-bar {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
            padding: 12px 16px;
            background: var(--bg-subtle);
            border-radius: var(--radius-md);
            margin-bottom: 24px;
        }

        .keywords-label {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .keyword-chip {
            display: inline-flex;
            padding: 3px 10px;
            background: white;
            border: 1px solid var(--border-light);
            border-radius: var(--radius-full);
            font-size: 0.78rem;
            color: var(--text-primary);
            font-weight: 500;
        }

        /* Third-party page enhancements */
        .tp-page-name-row {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .tp-connection-badge {
            font-size: 0.65rem;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: var(--radius-sm);
            background: rgba(37, 99, 235, 0.1);
            color: var(--accent-primary);
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        .tp-confidence {
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--accent-success);
        }

        .tp-domain-chip {
            font-size: 0.7rem;
            padding: 1px 6px;
            background: var(--bg-subtle);
            border-radius: var(--radius-sm);
            color: var(--text-muted);
            font-family: 'SF Mono', 'Cascadia Code', monospace;
            text-decoration: none;
            transition: var(--transition-fast);
        }

        a.tp-domain-chip:hover {
            background: var(--bg-hover);
            color: var(--accent-primary);
        }

        .tp-domain-block {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .tp-domain-urls {
            display: flex;
            flex-direction: column;
            gap: 1px;
            padding-left: 8px;
            border-left: 2px solid var(--border-light);
            margin-left: 4px;
        }

        .tp-domain-url {
            font-size: 0.65rem;
            font-family: 'SF Mono', 'Cascadia Code', monospace;
            color: var(--accent-primary);
            text-decoration: none;
            padding: 1px 4px;
            border-radius: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 320px;
            transition: var(--transition-fast);
        }

        .tp-domain-url:hover {
            background: rgba(37, 99, 235, 0.08);
            text-decoration: underline;
        }

        .tp-domains-used {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 4px;
        }

        /* ═══════════════════════════════════════════════════════════
           SECTION TITLES
        ═══════════════════════════════════════════════════════════ */
        .section-title {
            font-size: 1.15rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title-bar {
            width: 4px;
            height: 20px;
            background: var(--accent-primary);
            border-radius: 2px;
        }

        .section-count {
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text-muted);
            margin-left: 8px;
        }

        /* ═══════════════════════════════════════════════════════════
           FOOTER
        ═══════════════════════════════════════════════════════════ */
        .app-footer {
            background: var(--bg-card);
            border-top: 1px solid var(--border-light);
            padding: 24px 0;
            margin-top: auto;
        }

        .footer-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .footer-brand {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .footer-links {
            display: flex;
            gap: 24px;
        }

        .footer-links a {
            color: var(--text-secondary);
            text-decoration: none;
            transition: var(--transition-fast);
        }

        .footer-links a:hover {
            color: var(--accent-primary);
        }

        /* ═══════════════════════════════════════════════════════════
           RESPONSIVE
        ═══════════════════════════════════════════════════════════ */
        @media (max-width: 768px) {
            .header-content {
                flex-wrap: wrap;
            }

            .search-form {
                flex-direction: column;
            }

            .search-btn {
                width: 100%;
                justify-content: center;
            }

            .brand-tagline {
                display: none;
            }

            .tabs-wrapper {
                width: 100%;
                display: grid;
                grid-template-columns: repeat(2, 1fr);
            }

            .tab {
                text-align: center;
            }
        }

        /* Small inline spinner */
        .spinner-sm {
            width: 18px;
            height: 18px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
        }
        /* Top Landing Pages URLs */
        .top-urls-list {
            display: flex;
            flex-direction: column;
            gap: 0;
        }
        .top-url-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-light);
            gap: 16px;
        }
        .top-url-item:last-child { border-bottom: none; }
        .top-url-link {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            flex: 1;
            min-width: 0;
            padding-top: 2px;
        }
        .top-url-link a:hover { color: var(--accent-primary) !important; }
        .top-url-stats {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-shrink: 0;
        }
        .top-url-count {
            font-weight: 600;
            font-size: 14px;
            color: var(--accent-primary);
            min-width: 36px;
            text-align: right;
        }

        /* Success rate badge colors */
        .rate-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 10px;
            border-radius: var(--radius-full);
            font-size: 12px;
            font-weight: 600;
        }
        .rate-badge.high { background: #10b98120; color: #059669; }
        .rate-badge.medium { background: #f59e0b20; color: #d97706; }
        .rate-badge.low { background: #ef444420; color: #dc2626; }

        /* Debug Panel */
        .debug-panel {
            margin-top: 24px;
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
            background: var(--bg-card);
            overflow: hidden;
        }
        .debug-panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            cursor: pointer;
            background: var(--bg-subtle);
            border-bottom: 1px solid var(--border-light);
            user-select: none;
            transition: background var(--transition-fast);
        }
        .debug-panel-header:hover { background: var(--bg-hover); }
        .debug-panel-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .debug-panel-toggle {
            font-size: 12px;
            color: var(--text-muted);
            transition: transform var(--transition-fast);
        }
        .debug-panel-toggle.open { transform: rotate(180deg); }
        .debug-panel-body {
            padding: 16px;
            font-size: 12px;
            font-family: 'SF Mono', 'Fira Code', monospace;
            color: var(--text-secondary);
            max-height: 400px;
            overflow-y: auto;
            display: none;
        }
        .debug-panel-body.open { display: block; }
        .debug-row {
            display: flex;
            align-items: baseline;
            gap: 8px;
            padding: 3px 0;
            border-bottom: 1px solid var(--border-light);
        }
        .debug-row:last-child { border-bottom: none; }
        .debug-label { color: var(--text-muted); min-width: 120px; flex-shrink: 0; }
        .debug-value { color: var(--text-primary); word-break: break-all; }
        .debug-value.success { color: var(--accent-success); }
        .debug-value.fail { color: var(--accent-danger); }
        .debug-section-title {
            font-weight: 700;
            color: var(--text-primary);
            margin-top: 12px;
            margin-bottom: 6px;
            padding-bottom: 4px;
            border-bottom: 2px solid var(--border-medium);
        }
        .debug-section-title:first-child { margin-top: 0; }

        /* Enrichment progress bar */
        .enrichment-progress {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 12px;
            color: var(--text-muted);
        }
        .enrichment-progress-bar {
            flex: 1;
            height: 4px;
            background: var(--bg-subtle);
            border-radius: 2px;
            overflow: hidden;
        }
        .enrichment-progress-fill {
            height: 100%;
            background: var(--accent-primary);
            border-radius: 2px;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="app-wrapper">
        <!-- Header -->
        <header class="app-header">
            <div class="container">
                <div class="header-content">
                    <div class="brand">
                        <div class="brand-icon">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                            </svg>
                        </div>
                        <div class="brand-text">
                            <span class="brand-name">Brand Ad Intelligence</span>
                            <span class="brand-tagline">Meta Ad Library Analysis - Für Alon</span>
                        </div>
                    </div>
                    <div class="header-actions">
                        <div class="status-indicator">
                            <span class="status-dot"></span>
                            Live Tracking
                        </div>
                        <div class="country-select">
                            <span class="flag-emoji" id="flagEmoji">🇩🇪</span>
                            <select id="country" onchange="updateFlag()">
                                <option value="DE" selected>Deutschland</option>
                                <option value="AT">Österreich</option>
                                <option value="CH">Schweiz</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <div class="container">
                <!-- Search Section -->
                <section class="search-section">
                    <div class="search-card">
                        <div class="search-header">
                            <h1 class="search-title">Analysiere Meta Werbeanzeigen</h1>
                            <p class="search-subtitle">Gib einen Markennamen oder eine Facebook Page URL ein, um alle Werbeanzeigen zu finden.</p>
                        </div>
                        <div class="search-form">
                            <div class="search-input-wrapper">
                                <svg class="search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                                </svg>
                                <input type="text" id="query" class="search-input" placeholder="z.B. Red Bull, HOLY, facebook.com/cocacola" value="HOLY">
                            </div>
                            <button class="search-btn" id="searchBtn" onclick="searchPages()">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                                </svg>
                                Pages suchen
                            </button>
                        </div>
                    </div>
                </section>

                <!-- Page Selection -->
                <section class="page-selection" id="pageSelection">
                    <div class="selection-card">
                        <div class="selection-header">
                            <div class="selection-title">
                                <span id="selectionTitleText">Wähle die richtige Facebook Page</span>
                                <span class="selection-badge" id="pageCountBadge">0 gefunden</span>
                            </div>
                            <span class="search-status-text" id="fullSearchStatus"></span>
                        </div>
                        <div class="page-list" id="pageList"></div>
                        <button class="load-ads-btn" id="loadAdsBtn" onclick="loadAds()" disabled>
                            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                            </svg>
                            Ads von dieser Page laden
                        </button>
                    </div>
                </section>

                <!-- Tabs -->
                <div class="tabs-container" id="tabsContainer">
                    <div class="tabs-wrapper">
                        <button class="tab active" data-tab="overview" onclick="switchTab('overview')">Übersicht</button>
                        <button class="tab" data-tab="ads" onclick="switchTab('ads')">Anzeigen</button>
                        <button class="tab" data-tab="domains" onclick="switchTab('domains')">Domains</button>
                        <button class="tab" data-tab="thirdparty" onclick="switchTab('thirdparty')">Drittseiten</button>
                    </div>
                </div>

                <!-- Results -->
                <section class="results-section" id="results">
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                            </svg>
                        </div>
                        <h3 class="empty-state-title">Starte eine Suche</h3>
                        <p>Suche nach einer Marke und wähle die Facebook Page aus.</p>
                    </div>
                </section>
            </div>
        </main>

        <!-- Footer -->
        <footer class="app-footer">
            <div class="container">
                <div class="footer-content">
                    <div class="footer-brand">
                        <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                        </svg>
                        Brand Ad Intelligence — Made by Marlin
                    </div>
                    <div class="footer-links">
                        <a href="docs.html">Dokumentation</a>
                        
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <script>
        const API_BASE = 'https://manedsrnsgfunopkaypx.supabase.co/functions/v1';

        let selectedPageId = null;
        let selectedPageName = null;
        let currentData = null;
        let currentTab = 'overview';
        let enrichedUrlData = null; // Full URL enrichment results
        let enrichmentLoading = false;

        
        function updateFlag() {
            const country = document.getElementById('country').value;
            const flags = { DE: '🇩🇪', AT: '🇦🇹', CH: '🇨🇭' };
            document.getElementById('flagEmoji').textContent = flags[country] || '🇩🇪';
        }

        // Step 1: Search for pages (PARALLEL: Quick + Full Search)
        async function searchPages() {
            const query = document.getElementById('query').value.trim();
            const country = document.getElementById('country').value;

            if (!query) {
                alert('Bitte gib einen Suchbegriff ein');
                return;
            }

            const btn = document.getElementById('searchBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-sm"></span> Suche...';

            // Reset state
            selectedPageId = null;
            document.getElementById('pageSelection').classList.remove('visible');
            document.getElementById('results').classList.remove('visible');
            document.getElementById('tabsContainer').classList.remove('visible');
            document.getElementById('loadAdsBtn').disabled = true;

            const requestBody = JSON.stringify({ query, country });

            // Start BOTH searches in parallel
            const quickPromise = fetch(`${API_BASE}/page-search-quick`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: requestBody
            }).then(r => r.json()).catch(e => ({ success: false, error: e.message }));

            const fullPromise = fetch(`${API_BASE}/page-search`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: requestBody
            }).then(r => r.json()).catch(e => ({ success: false, error: e.message }));

            let hasQuickResults = false;

            // Handle QUICK results first (should arrive in 2-3 seconds)
            let apiError = null;
            try {
                const quickData = await quickPromise;
                console.log('Quick search result:', quickData);

                if (quickData.success && quickData.pages && quickData.pages.length > 0) {
                    hasQuickResults = true;
                    updateSearchStatus('quick', quickData.pages.length, quickData.search_time_ms);
                    renderPageList(quickData.pages, true);
                    document.getElementById('pageSelection').classList.add('visible');
                } else if (!quickData.success && quickData.error) {
                    apiError = quickData.error;
                }
            } catch (error) {
                console.log('Quick search failed:', error);
            }

            // Handle FULL results (arrives later, updates the list)
            try {
                const fullData = await fullPromise;
                console.log('Full search result:', fullData);

                if (fullData.success && fullData.pages && fullData.pages.length > 0) {
                    updateSearchStatus('full', fullData.pages.length);
                    renderPageList(fullData.pages, false);
                    document.getElementById('pageSelection').classList.add('visible');
                } else if (!hasQuickResults) {
                    // Check if there's an API error (rate limit, auth, etc.)
                    const errorMsg = (fullData.error || apiError);
                    if (errorMsg) {
                        alert(errorMsg);
                    } else {
                        alert('Keine Pages gefunden für: ' + query);
                    }
                }
            } catch (error) {
                console.error('Full search error:', error);
                if (!hasQuickResults) {
                    alert(apiError || 'Fehler: ' + error.message);
                }
            }

            // Reset button
            btn.disabled = false;
            btn.innerHTML = `
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                </svg>
                Pages suchen
            `;
        }

        function updateSearchStatus(type, count, timeMs) {
            const badgeEl = document.getElementById('pageCountBadge');
            const statusEl = document.getElementById('fullSearchStatus');

            if (type === 'quick') {
                badgeEl.textContent = `${count} gefunden`;
                statusEl.textContent = '⏳ Vollständige Suche läuft...';
                statusEl.className = 'search-status-text loading';
            } else if (type === 'full') {
                badgeEl.textContent = `${count} gefunden`;
                statusEl.textContent = '✓ Suche abgeschlossen';
                statusEl.className = 'search-status-text complete';
            }
        }

        function renderPageList(pages, isQuickResult = false) {
            const container = document.getElementById('pageList');
            const matchLabels = {
                'direct': 'Direkt',
                'exact_name': 'Exakt',
                'domain_match': 'Domain',
                'keyword_match': 'Keyword'
            };

            // Keep selected page ID if updating from quick to full
            const previousSelectedId = selectedPageId;

            container.innerHTML = pages.map(page => `
                <div class="page-option ${page.page_id === previousSelectedId ? 'selected' : ''} ${isQuickResult ? 'quick-result' : ''}"
                     data-page-id="${page.page_id}"
                     data-page-name="${page.page_name}"
                     onclick="selectPage(this)">
                    <div class="page-info">
                        <div class="page-name-row">
                            <h3>${page.page_name}</h3>
                            ${page.match_type ? `<span class="match-badge ${page.match_type}">${matchLabels[page.match_type] || page.match_type}</span>` : ''}
                            ${isQuickResult ? '<span class="quick-badge">⚡</span>' : ''}
                        </div>
                        ${page.top_domain ? `<div class="page-domain">${page.top_domain}</div>` : ''}
                        <div class="page-id">ID: ${page.page_id}</div>
                    </div>
                    <div class="page-stats">
                        <div class="ad-count">${isQuickResult ? '~' : ''}${page.ad_count.toLocaleString()}</div>
                        <div class="ad-label">Ads${isQuickResult ? ' (Vorschau)' : ''}</div>
                        ${page.sample_reach > 0 ? `<div class="page-reach">~${formatNumber(page.sample_reach)} Reach</div>` : ''}
                    </div>
                </div>
            `).join('');

            // Restore selection if it was previously selected
            if (previousSelectedId) {
                const selectedEl = container.querySelector(`[data-page-id="${previousSelectedId}"]`);
                if (selectedEl) {
                    selectedEl.classList.add('selected');
                    document.getElementById('loadAdsBtn').disabled = false;
                }
            }
        }

        function selectPage(element) {
            // Deselect all
            document.querySelectorAll('.page-option').forEach(el => el.classList.remove('selected'));
            // Select clicked
            element.classList.add('selected');
            selectedPageId = element.dataset.pageId;
            selectedPageName = element.dataset.pageName;
            document.getElementById('loadAdsBtn').disabled = false;
        }

        // Step 2: Load ads from selected page
        async function loadAds() {
            if (!selectedPageId) return;

            // Reset third party data and enrichment when loading new page
            thirdPartyData = null;
            thirdPartyLoading = false;
            thirdPartyCacheChecked = false;
            enrichedUrlData = null;
            enrichmentLoading = false;
            enrichmentFirstCall = true;

            const country = document.getElementById('country').value;
            const btn = document.getElementById('loadAdsBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-sm"></span> Lade alle Ads...';

            document.getElementById('results').classList.add('visible');
            document.getElementById('results').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p class="loading-text">Lade alle Ads von "${selectedPageName}"...</p>
                    <p class="loading-subtext">Dies kann einen Moment dauern.</p>
                </div>
            `;

            try {
                const response = await fetch(`${API_BASE}/brand-search`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ page_id: selectedPageId, country })
                });

                currentData = await response.json();
                console.log('Brand search result:', currentData);

                if (currentData.success) {
                    document.getElementById('tabsContainer').classList.add('visible');
                    renderCurrentTab();
                    // Start URL enrichment in background (uses ScrapingBee when configured)
                    enrichUrlsInBackground();
                } else {
                    document.getElementById('results').innerHTML = `
                        <div class="error-message">
                            <p><strong>Fehler:</strong> ${currentData.error}</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('results').innerHTML = `
                    <div class="error-message">
                        <p><strong>Fehler:</strong> ${error.message}</p>
                    </div>
                `;
            } finally {
                btn.disabled = false;
                btn.innerHTML = `
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                    </svg>
                    Ads von dieser Page laden
                `;
            }
        }

        /**
         * Enriches ad URLs in background — extracts full landing page URLs from ad snapshots
         */
        let enrichmentFirstCall = true; // Track if this is the first enrichment call for this page

        async function enrichUrlsInBackground() {
            if (!currentData?.ads?.length || enrichmentLoading) return;

            enrichmentLoading = true;
            enrichedUrlData = null;

            // === SMART SAMPLING ===
            // Instead of sending first 50 ads, group ALL ads by domain and sample
            // 10 per domain. This covers ALL domains with minimal ScrapingBee credits.
            const MAX_SAMPLE_TOTAL = 30;
            const SAMPLES_PER_DOMAIN = 10;

            const allAdsWithSnapshots = currentData.ads.filter(ad => ad.creative_url);

            // Group by landing_page_domain
            const adsByDomain = {};
            for (const ad of allAdsWithSnapshots) {
                const domain = ad.landing_page_domain || '_unknown';
                if (!adsByDomain[domain]) adsByDomain[domain] = [];
                adsByDomain[domain].push(ad);
            }

            const domainEntries = Object.entries(adsByDomain);
            const domainCount = domainEntries.length;

            // Calculate samples per domain (cap total at MAX_SAMPLE_TOTAL)
            let samplesPerDomain = SAMPLES_PER_DOMAIN;
            if (domainCount * SAMPLES_PER_DOMAIN > MAX_SAMPLE_TOTAL) {
                samplesPerDomain = Math.max(2, Math.floor(MAX_SAMPLE_TOTAL / domainCount));
            }

            // For each domain, pick diverse ads (unique snapshot URLs)
            const sampledAds = [];
            const domainTotals = {}; // domain -> total ad count (for extrapolation)
            const domainSampled = {}; // domain -> sampled count

            for (const [domain, domainAds] of domainEntries) {
                domainTotals[domain] = domainAds.length;

                // Deduplicate by snapshot URL for diverse samples
                const seenSnapshots = new Set();
                const uniqueAds = [];
                for (const ad of domainAds) {
                    if (!seenSnapshots.has(ad.creative_url)) {
                        seenSnapshots.add(ad.creative_url);
                        uniqueAds.push(ad);
                    }
                }

                const selected = uniqueAds.slice(0, samplesPerDomain);
                domainSampled[domain] = selected.length;
                for (const ad of selected) {
                    sampledAds.push({
                        ad_id: ad.id,
                        snapshot_url: ad.creative_url,
                        domain: ad.landing_page_domain || undefined
                    });
                }
            }

            if (sampledAds.length === 0) {
                enrichmentLoading = false;
                return;
            }

            console.log(`[URL] Smart Sampling: ${domainCount} domains, ${sampledAds.length} sampled (from ${allAdsWithSnapshots.length} total)`);
            for (const [domain, ads] of domainEntries) {
                console.log(`[URL]   ${domain}: ${ads.length} total → ${domainSampled[domain]} sampled`);
            }

            // Re-render to show loading state
            if (currentTab === 'overview') renderCurrentTab();

            try {
                const response = await fetch(`${API_BASE}/url-enrichment`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        page_id: selectedPageId,
                        ads: sampledAds,
                        use_headless: true,
                        clear_cache: enrichmentFirstCall
                    })
                });

                enrichmentFirstCall = false;
                enrichedUrlData = await response.json();
                console.log('[URL] Enrichment result:', enrichedUrlData);
                if (enrichedUrlData._diagnostics) {
                    console.log('[URL] Diagnostics:', JSON.stringify(enrichedUrlData._diagnostics, null, 2));
                }

                if (enrichedUrlData.success) {
                    // Update sampled ad objects with full URLs
                    const urlMap = new Map();
                    const badDomains = ['facebook.com','fb.com','instagram.com','meta.com','meta.ai','fbcdn.net'];
                    for (const u of (enrichedUrlData.urls || [])) {
                        if (!u.full_url) continue;
                        try {
                            const h = new URL(u.full_url).hostname.toLowerCase();
                            if (badDomains.some(d => h === d || h.endsWith('.'+d))) continue;
                        } catch { continue; }
                        urlMap.set(u.ad_id, u);
                    }
                    for (const ad of currentData.ads) {
                        const enriched = urlMap.get(ad.id);
                        if (enriched) {
                            ad.landing_page_url = enriched.full_url;
                            ad.landing_page_full_path = enriched.full_path;
                        }
                    }

                    // === EXTRAPOLATE COUNTS ===
                    // top_landing_pages counts are from the SAMPLE only.
                    // Extrapolate to all ads based on domain sample ratios.
                    // NOTE: Use the actual URL domain for ratio lookup, NOT lp.domain (which is the ad's domain).
                    // Example: monapure.de ads redirect to miavola.de URLs — we need miavola.de's ratio.
                    if (enrichedUrlData.top_landing_pages) {
                        for (const lp of enrichedUrlData.top_landing_pages) {
                            // Derive domain from actual URL, fall back to lp.domain
                            let lpDomain = lp.domain;
                            try {
                                const urlDomain = new URL(lp.url).hostname.replace(/^www\./, '').toLowerCase();
                                // Use URL domain if we have totals for it, otherwise try ad domain
                                if (domainTotals[urlDomain]) {
                                    lpDomain = urlDomain;
                                }
                            } catch {}
                            const totalForDomain = domainTotals[lpDomain] || domainTotals['_unknown'] || 0;
                            const sampledForDomain = domainSampled[lpDomain] || domainSampled['_unknown'] || 0;

                            if (sampledForDomain > 0 && totalForDomain > sampledForDomain) {
                                lp.sample_count = lp.count;
                                lp.estimated_count = Math.round(lp.count * (totalForDomain / sampledForDomain));
                                lp.count = lp.estimated_count;
                            }
                        }
                        // Re-sort after extrapolation
                        enrichedUrlData.top_landing_pages.sort((a, b) => b.count - a.count);
                    }

                    // Store sampling metadata for display
                    enrichedUrlData._sampling = {
                        total_ads_with_snapshots: allAdsWithSnapshots.length,
                        sampled_ads: sampledAds.length,
                        domains: domainCount,
                        domain_totals: domainTotals,
                        domain_sampled: domainSampled,
                    };

                    // Re-render current tab to show updated URLs
                    renderCurrentTab();
                }
            } catch (error) {
                console.error('[URL] Enrichment error:', error);
                enrichedUrlData = { success: false, error: String(error) };
                renderCurrentTab();
            } finally {
                enrichmentLoading = false;
            }
        }

        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
            renderCurrentTab();
        }

        function renderCurrentTab() {
            if (!currentData) return;
            switch (currentTab) {
                case 'overview': renderOverview(); break;
                case 'ads': renderAds(); break;
                case 'domains': renderDomains(); break;
                case 'thirdparty': renderThirdParty(); break;
            }
        }

        function renderOverview() {
            const d = currentData;
            const totalReach = d.ads.reduce((sum, ad) => sum + (ad.reach || 0), 0);
            const activeAds = d.ads.filter(a => a.status === 'active').length;

            document.getElementById('results').innerHTML = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Gefundene Anzeigen</div>
                        <div class="stat-value accent">${d.total_ads.toLocaleString()}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Aktive Ads</div>
                        <div class="stat-value">${activeAds.toLocaleString()}</div>
                        <span class="stat-change positive">
                            <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"/>
                            </svg>
                            Live
                        </span>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Gesamte Reichweite</div>
                        <div class="stat-value">${formatNumber(totalReach)}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Domains</div>
                        <div class="stat-value">${d.domains?.length || 0}</div>
                    </div>
                </div>

                <div class="content-card">
                    <div class="card-header">
                        <div class="card-title">
                            <div class="card-title-icon blue">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"/>
                                </svg>
                            </div>
                            Top Domains
                        </div>
                        <a href="#" class="card-action" onclick="switchTab('domains'); return false;">
                            Alle anzeigen
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                            </svg>
                        </a>
                    </div>
                    <div class="card-body">
                        <div class="domains-list">
                            ${(d.domains || []).slice(0, 5).map(domain => `
                                <div class="domain-item">
                                    <div class="domain-info">
                                        <div class="domain-icon">🌐</div>
                                        <div class="domain-name">
                                            <a href="https://${domain}" target="_blank">${domain}</a>
                                        </div>
                                    </div>
                                    <span class="domain-badge">Landing Page</span>
                                </div>
                            `).join('') || '<p style="color:var(--text-muted);">Keine Domains gefunden</p>'}
                        </div>
                    </div>
                </div>

                ${renderTopLandingPages()}

                <h3 class="section-title">
                    <span class="section-title-bar"></span>
                    Neueste Anzeigen
                </h3>
                <div class="ads-grid">
                    ${d.ads.slice(0, 3).map(ad => renderAdCard(ad)).join('')}
                </div>
            `;
        }

        function renderTopLandingPages() {
            // Combine data from enrichment (if available) and ad captions
            const enrichedPages = enrichedUrlData?.top_landing_pages || [];
            const isLoading = enrichmentLoading && !enrichedUrlData;

            // Also compute from ad data (captions may have paths)
            const ads = currentData?.ads || [];
            const urlCounts = {};
            for (const ad of ads) {
                const url = ad.landing_page_url;
                if (!url) continue;
                const normalized = url.replace(/\/+$/, '').toLowerCase();
                try {
                    const parsed = new URL(normalized);
                    if (parsed.pathname === '/' || parsed.pathname === '') continue;
                } catch { continue; }
                if (!urlCounts[normalized]) urlCounts[normalized] = { url: normalized, count: 0 };
                urlCounts[normalized].count++;
            }

            // Filter out platform/garbage URLs
            const platformDomains = ['facebook.com','fb.com','instagram.com','meta.com','meta.ai','fbcdn.net','facebook.net','threads.net','whatsapp.com'];
            function isPlatformUrl(url) {
                try {
                    const h = new URL(url).hostname.toLowerCase();
                    return platformDomains.some(d => h === d || h.endsWith('.'+d));
                } catch { return true; }
            }

            // Merge: enriched URLs take priority, then caption URLs
            const mergedMap = {};
            for (const ep of enrichedPages) {
                if (isPlatformUrl(ep.url)) continue;
                const key = ep.url.replace(/\/+$/, '').toLowerCase();
                mergedMap[key] = { url: ep.url, count: ep.count };
            }
            for (const [url, info] of Object.entries(urlCounts)) {
                if (isPlatformUrl(url)) continue;
                if (!mergedMap[url]) mergedMap[url] = info;
            }

            const topPages = Object.values(mergedMap)
                .sort((a, b) => b.count - a.count)
                .slice(0, 5);

            const enrichedCount = enrichedUrlData?.enriched_count || 0;
            const enrichedTotal = enrichedUrlData?.total_count || 0;
            const enrichedPct = enrichedUrlData?.success_rate || 0;
            const breakdown = enrichedUrlData?.breakdown || {};
            const diag = enrichedUrlData?._diagnostics || {};
            const scrapeTime = enrichedUrlData?.scrape_time_ms || 0;

            // Success rate color
            const rateClass = enrichedPct >= 80 ? 'high' : enrichedPct >= 50 ? 'medium' : 'low';

            const sampling = enrichedUrlData?._sampling;

            let statsHtml = '';
            if (enrichedUrlData && enrichedPct > 0) {
                const samplingInfo = sampling
                    ? `Stichprobe: ${sampling.sampled_ads}/${sampling.total_ads_with_snapshots} Ads (${sampling.domains} ${sampling.domains === 1 ? 'Domain' : 'Domains'})`
                    : `${enrichedCount}/${enrichedTotal} URLs`;
                statsHtml = `
                    <div style="display:flex;align-items:center;gap:10px;">
                        <span class="rate-badge ${rateClass}">${enrichedPct}%</span>
                        <span style="font-size:12px;color:var(--text-muted);">${samplingInfo}</span>
                        ${diag.scrapingbee_credits_used ? `<span style="font-size:11px;color:var(--text-muted);">| ${diag.scrapingbee_credits_used} Credits</span>` : ''}
                        ${scrapeTime ? `<span style="font-size:11px;color:var(--text-muted);">| ${(scrapeTime/1000).toFixed(1)}s</span>` : ''}
                    </div>`;
            } else if (isLoading) {
                statsHtml = `<div id="enrichmentProgressArea" class="enrichment-progress">
                    <span class="spinner-sm" style="border-color:rgba(37,99,235,0.3);border-top-color:var(--accent-primary);"></span>
                    <span id="enrichmentProgressText">URLs werden extrahiert...</span>
                </div>`;
            }

            // Debug panel HTML
            let debugHtml = '';
            if (enrichedUrlData && (diag.failed_ads?.length > 0 || breakdown.from_cache > 0 || breakdown.from_headless > 0)) {
                debugHtml = `
                <div class="debug-panel" style="margin-top:16px;">
                    <div class="debug-panel-header" onclick="this.nextElementSibling.classList.toggle('open'); this.querySelector('.debug-panel-toggle').classList.toggle('open');">
                        <div class="debug-panel-title">
                            <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"/></svg>
                            Debug Logs
                        </div>
                        <span class="debug-panel-toggle">&#9660;</span>
                    </div>
                    <div class="debug-panel-body">
                        ${sampling ? `
                            <div class="debug-section-title">Smart Sampling</div>
                            <div class="debug-row"><span class="debug-label">Gesamt Ads</span><span class="debug-value">${sampling.total_ads_with_snapshots}</span></div>
                            <div class="debug-row"><span class="debug-label">Stichprobe</span><span class="debug-value">${sampling.sampled_ads}</span></div>
                            <div class="debug-row"><span class="debug-label">Domains</span><span class="debug-value">${sampling.domains}</span></div>
                            ${Object.entries(sampling.domain_totals || {}).map(([d, total]) =>
                                `<div class="debug-row"><span class="debug-label" style="padding-left:12px;">${d}</span><span class="debug-value">${sampling.domain_sampled[d] || 0}/${total}</span></div>`
                            ).join('')}
                        ` : ''}
                        <div class="debug-section-title">Extraction Breakdown</div>
                        <div class="debug-row"><span class="debug-label">Cache Hits</span><span class="debug-value">${breakdown.from_cache || 0}</span></div>
                        <div class="debug-row"><span class="debug-label">HTML Parse</span><span class="debug-value">${breakdown.from_html_parse || 0}</span></div>
                        <div class="debug-row"><span class="debug-label">ScrapingBee</span><span class="debug-value">${breakdown.from_headless || 0}</span></div>
                        <div class="debug-row"><span class="debug-label">Failed</span><span class="debug-value fail">${breakdown.failed || 0}</span></div>
                        <div class="debug-row"><span class="debug-label">Credits Used</span><span class="debug-value">${diag.scrapingbee_credits_used || 0}</span></div>
                        <div class="debug-row"><span class="debug-label">Duration</span><span class="debug-value">${(scrapeTime/1000).toFixed(1)}s</span></div>
                        ${diag.failed_ads?.length > 0 ? `
                            <div class="debug-section-title">Failed Ads (Top ${diag.failed_ads.length})</div>
                            ${diag.failed_ads.map(f => `
                                <div class="debug-row">
                                    <span class="debug-label">${f.ad_id.substring(0,12)}...</span>
                                    <span class="debug-value fail">${f.reason || 'unknown'} | ${(f.stages||[]).join(' → ')}</span>
                                </div>
                            `).join('')}
                        ` : ''}
                    </div>
                </div>`;
            }

            return `
                <div class="content-card" style="margin-bottom: 24px;">
                    <div class="card-header">
                        <div class="card-title">
                            <div class="card-title-icon" style="background: linear-gradient(135deg, #f59e0b20, #f59e0b10); color: #f59e0b;">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/>
                                </svg>
                            </div>
                            Top Landingpages
                        </div>
                        ${statsHtml}
                    </div>
                    <div class="card-body">
                        ${isLoading ? `
                            <div style="display:flex;align-items:center;gap:10px;padding:12px 0;color:var(--text-muted);">
                                <span class="spinner-sm" style="border-color:rgba(37,99,235,0.3);border-top-color:var(--accent-primary);"></span>
                                URLs werden extrahiert...
                            </div>
                        ` : topPages.length > 0 ? `
                            <div class="top-urls-list">
                                ${topPages.map((lp, i) => {
                                    const displayUrl = lp.url.replace(/^https?:\/\//, '');
                                    const truncatedUrl = displayUrl.length > 70 ? displayUrl.substring(0, 67) + '...' : displayUrl;
                                    return `
                                        <div class="top-url-item">
                                            <div style="display:flex;align-items:center;gap:8px;flex-shrink:0;width:28px;">
                                                <span style="font-size:13px;font-weight:700;color:var(--text-muted);">#${i+1}</span>
                                            </div>
                                            <div class="top-url-link">
                                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="flex-shrink:0;opacity:0.5;">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                                                </svg>
                                                <a href="${lp.url}" target="_blank" title="${displayUrl}" style="color:var(--text-primary);text-decoration:none;font-size:13px;font-family:monospace;word-break:break-all;">${truncatedUrl}</a>
                                            </div>
                                            <div class="top-url-stats">
                                                <span class="top-url-count">${lp.estimated_count ? '~' : ''}${lp.count} Ads</span>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                            ${debugHtml}
                        ` : enrichedUrlData ? `
                            <p style="color:var(--text-muted);padding:8px 0;">
                                Keine Landing-Page-URLs mit Pfad gefunden.
                                ${enrichedPct === 0 ? 'ScrapingBee konnte keine URLs extrahieren.' : ''}
                            </p>
                            ${debugHtml}
                        ` : `
                            <p style="color:var(--text-muted);padding:8px 0;">
                                URLs werden nach dem Laden automatisch extrahiert...
                            </p>
                        `}
                    </div>
                </div>
            `;
        }

        function renderAds() {
            const d = currentData;
            document.getElementById('results').innerHTML = `
                <h3 class="section-title">
                    <span class="section-title-bar"></span>
                    Alle Anzeigen
                    <span class="section-count">${d.total_ads} gefunden</span>
                </h3>
                <div class="ads-grid">
                    ${d.ads.slice(0, 50).map(ad => renderAdCard(ad)).join('')}
                </div>
                ${d.total_ads > 50 ? `<p style="color:var(--text-muted);text-align:center;margin-top:24px;">Zeige 50 von ${d.total_ads} Ads</p>` : ''}
            `;
        }

        function renderAdCard(ad) {
            const initials = (ad.page_name || 'U').substring(0, 2).toUpperCase();
            return `
                <div class="ad-card">
                    <div class="ad-header">
                        <div class="ad-page-info">
                            <div class="ad-page-avatar">${initials}</div>
                            <div>
                                <div class="ad-page-name">${ad.page_name || 'Unbekannt'}</div>
                                ${ad.start_date ? `<div class="ad-page-date">Gestartet: ${new Date(ad.start_date).toLocaleDateString('de-DE')}</div>` : ''}
                            </div>
                        </div>
                        <div class="ad-badges">
                            ${ad.reach_formatted ? `<span class="reach-badge">${ad.reach_formatted} Reach</span>` : ''}
                            <span class="ad-status ${ad.status}">${ad.status === 'active' ? 'Aktiv' : 'Inaktiv'}</span>
                        </div>
                    </div>
                    ${ad.headline ? `<div class="ad-headline">${ad.headline}</div>` : ''}
                    <div class="ad-text">${ad.primary_text || 'Kein Text verfügbar'}</div>
                    <div class="ad-meta">
                        ${ad.platforms?.length ? `
                            <span class="ad-meta-item">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                                </svg>
                                ${ad.platforms.join(', ')}
                            </span>
                        ` : ''}
                        ${ad.landing_page_url ? `
                            <span class="ad-meta-item" style="word-break:break-all;">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="flex-shrink:0;">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/>
                                </svg>
                                ${ad.landing_page_url.replace(/^https?:\/\//, '').substring(0, 50)}${ad.landing_page_url.length > 58 ? '...' : ''}
                            </span>
                        ` : ad.landing_page_domain ? `
                            <span class="ad-meta-item">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/>
                                </svg>
                                ${ad.landing_page_domain}
                            </span>
                        ` : ''}
                    </div>
                    <div class="ad-links">
                        ${ad.creative_url ? `
                            <a href="${ad.creative_url}" target="_blank" class="ad-link primary">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                </svg>
                                Creative ansehen
                            </a>
                        ` : ''}
                        ${ad.landing_page_url ? `
                            <a href="${ad.landing_page_url}" target="_blank" class="ad-link secondary">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                                </svg>
                                Landing Page
                            </a>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function renderDomains() {
            const d = currentData;
            document.getElementById('results').innerHTML = `
                <h3 class="section-title">
                    <span class="section-title-bar"></span>
                    Alle Domains
                    <span class="section-count">${d.domains?.length || 0} gefunden</span>
                </h3>
                <div class="content-card">
                    <div class="card-body">
                        <div class="domains-list">
                            ${(d.domains || []).map(domain => `
                                <div class="domain-item">
                                    <div class="domain-info">
                                        <div class="domain-icon">🌐</div>
                                        <div class="domain-name">
                                            <a href="https://${domain}" target="_blank">${domain}</a>
                                        </div>
                                    </div>
                                    <span class="domain-badge">Landing Page</span>
                                </div>
                            `).join('') || '<p style="color:var(--text-muted);">Keine Domains gefunden</p>'}
                        </div>
                    </div>
                </div>
            `;
        }

        // Drittseiten Finder (Teil 2) — Brand Discovery
        let thirdPartyData = null;
        let thirdPartyLoading = false;
        let thirdPartyCacheChecked = false;
        let discoveryJobId = null;
        let discoveryPollInterval = null;

        async function renderThirdParty() {
            const resultsEl = document.getElementById('results');

            // Show cached data if available in memory
            if (thirdPartyData) {
                renderThirdPartyContent(thirdPartyData);
                return;
            }

            // Show loading state with progress
            if (thirdPartyLoading) {
                resultsEl.innerHTML = `
                    <div class="loading">
                        <div class="spinner"></div>
                        <p class="loading-text">Analysiere Drittseiten für "${selectedPageName}"...</p>
                        <p class="loading-subtext" id="discoveryProgress">Starte Discovery-Pipeline...</p>
                    </div>
                `;
                return;
            }

            // Check backend cache first (no force_refresh)
            if (selectedPageName && !thirdPartyCacheChecked) {
                thirdPartyCacheChecked = true;
                resultsEl.innerHTML = `
                    <div class="loading">
                        <div class="spinner"></div>
                        <p class="loading-text">Prüfe Cache...</p>
                    </div>
                `;
                try {
                    const country = document.getElementById('country').value;
                    const response = await fetch(`${API_BASE}/brand-discovery`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            brand: selectedPageName,
                            country,
                            use_headless: false,
                        })
                    });
                    const data = await response.json();
                    if (data.success && data.status === 'cached') {
                        console.log('Loaded from cache:', data);
                        thirdPartyData = data;
                        window._discoveryResult = data;
                        renderThirdPartyContent(data);
                        return;
                    }
                } catch (e) {
                    console.log('Cache check failed:', e);
                }
            }

            // Show start screen with discovery button
            resultsEl.innerHTML = `
                <div class="discovery-start">
                    <div class="discovery-info">
                        <h3 style="font-size:1.25rem;margin-bottom:8px;">Drittseiten-Finder</h3>
                        <p style="color:var(--text-secondary);max-width:600px;margin-bottom:24px;">
                            Findet ALLE Facebook Pages die Ads für "${selectedPageName}" schalten —
                            auch Drittseiten die den Brand-Namen nie erwähnen.
                            Folgt Presell-Seiten bis zum Checkout um den Brand zu identifizieren.
                        </p>
                        <div style="display:flex;gap:12px;flex-wrap:wrap;">
                            <button class="btn-discovery" onclick="startDiscovery()">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="20" height="20">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                                </svg>
                                Tiefensuche
                            </button>
                            <button class="btn-discovery-quick" onclick="startQuickDiscovery()">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="16" height="16">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                                </svg>
                                Schnellsuche
                            </button>
                        </div>
                        <p style="color:var(--text-muted);font-size:0.8rem;margin-top:12px;">
                            <strong>Tiefensuche:</strong> Alle Domains, 8 Keywords, ~15 Min — findet 80-90% aller Drittseiten.<br>
                            <strong>Schnellsuche:</strong> Top 15 Domains, 3 Keywords, ~60 Sek — schneller Überblick.
                        </p>
                    </div>
                </div>
            `;
        }

        function clearDiscoveryCache() {
            thirdPartyData = null;
            thirdPartyCacheChecked = true; // Don't re-check cache
            renderThirdParty(); // Back to start screen with Tiefensuche/Schnellsuche
        }

        async function startDiscovery(forceRefresh = false) {
            thirdPartyData = null;
            thirdPartyLoading = true;
            const resultsEl = document.getElementById('results');

            resultsEl.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p class="loading-text">Brand Discovery für "${selectedPageName}"${forceRefresh ? ' (Force Refresh)' : ''}</p>
                    <p class="loading-subtext" id="discoveryProgress">Starte Pipeline...</p>
                </div>
            `;

            try {
                const country = document.getElementById('country').value;
                const response = await fetch(`${API_BASE}/brand-discovery`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        brand: selectedPageName,
                        country,
                        use_headless: true,
                        force_refresh: forceRefresh,
                    })
                });

                const data = await response.json();
                console.log('Discovery response:', data);

                // Check if result is cached or completed immediately
                if (data.status === 'cached' || data.status === 'completed') {
                    thirdPartyData = data;
                    window._discoveryResult = data;
                    thirdPartyLoading = false;
                    renderThirdPartyContent(data);
                    return;
                }

                // Job is processing — start polling
                if (data.status === 'processing' && data.job_id) {
                    discoveryJobId = data.job_id;
                    updateDiscoveryProgress('Pipeline gestartet, bitte warten...');
                    startPolling();
                    return;
                }

                // Error
                thirdPartyLoading = false;
                const errorMsg = data.error || data.message || 'Unbekannter Fehler';
                const isResourceLimit = data.code === 'WORKER_LIMIT';
                resultsEl.innerHTML = `
                    <div class="error-message">
                        <p><strong>Fehler:</strong> ${errorMsg}</p>
                        ${isResourceLimit ? '<p style="margin-top:8px;color:var(--text-secondary);font-size:0.85rem;">Die Brand hat zu viele Ads/Keywords für die Edge Function. Versuche es mit "Quick Scan" oder warte auf den VPS Worker.</p>' : ''}
                        <div style="display:flex;gap:8px;margin-top:12px;">
                            <button class="btn-discovery-quick" onclick="renderThirdParty()">Zurück</button>
                            ${isResourceLimit ? '<button class="btn-discovery-quick" onclick="startQuickScan()">Quick Scan starten</button>' : ''}
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Discovery error:', error);
                thirdPartyLoading = false;
                resultsEl.innerHTML = `
                    <div class="error-message">
                        <p><strong>Fehler:</strong> ${error.message}</p>
                        <button class="btn-discovery-quick" onclick="renderThirdParty()" style="margin-top:12px;">Zurück</button>
                    </div>
                `;
            }
        }

        async function startQuickDiscovery() {
            thirdPartyLoading = true;
            thirdPartyData = null;
            const resultsEl = document.getElementById('results');

            resultsEl.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p class="loading-text">Schnellsuche für "${selectedPageName}"</p>
                    <p class="loading-subtext" id="discoveryProgress">Starte Pipeline (Edge Function)...</p>
                </div>
            `;

            try {
                const country = document.getElementById('country').value;
                const response = await fetch(`${API_BASE}/brand-discovery`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        brand: selectedPageName,
                        country,
                        use_headless: true,
                        mode: 'quick',
                        force_refresh: true,
                    })
                });

                const data = await response.json();
                console.log('Quick discovery response:', data);
                thirdPartyLoading = false;

                if (data.success) {
                    thirdPartyData = data;
                    window._discoveryResult = data;
                    renderThirdPartyContent(data);
                } else {
                    resultsEl.innerHTML = `
                        <div class="error-message">
                            <p><strong>Fehler:</strong> ${data.error || 'Unbekannter Fehler'}</p>
                            <button class="btn-discovery-quick" onclick="renderThirdParty()" style="margin-top:12px;">Zurück</button>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Quick discovery error:', error);
                thirdPartyLoading = false;
                resultsEl.innerHTML = `
                    <div class="error-message">
                        <p><strong>Fehler:</strong> ${error.message}</p>
                        <button class="btn-discovery-quick" onclick="renderThirdParty()" style="margin-top:12px;">Zurück</button>
                    </div>
                `;
            }
        }

        function startPolling() {
            if (discoveryPollInterval) clearInterval(discoveryPollInterval);

            discoveryPollInterval = setInterval(async () => {
                if (!discoveryJobId) {
                    clearInterval(discoveryPollInterval);
                    return;
                }

                try {
                    const response = await fetch(
                        `${API_BASE}/brand-discovery?job_id=${discoveryJobId}`
                    );
                    const data = await response.json();

                    if (data.status === 'completed' && data.result) {
                        clearInterval(discoveryPollInterval);
                        discoveryPollInterval = null;
                        discoveryJobId = null;
                        thirdPartyData = data.result;
                        thirdPartyLoading = false;
                        renderThirdPartyContent(data.result);
                    } else if (data.status === 'error') {
                        clearInterval(discoveryPollInterval);
                        discoveryPollInterval = null;
                        discoveryJobId = null;
                        thirdPartyLoading = false;
                        document.getElementById('results').innerHTML = `
                            <div class="error-message">
                                <p><strong>Fehler:</strong> ${data.error || 'Pipeline fehlgeschlagen'}</p>
                                <button class="btn-discovery-quick" onclick="renderThirdParty()" style="margin-top:12px;">Zurück</button>
                            </div>
                        `;
                    } else {
                        // Still processing — update progress
                        updateDiscoveryProgress(data.progress || 'Verarbeite...');
                    }
                } catch (error) {
                    console.log('Poll error:', error);
                }
            }, 3000); // Poll every 3 seconds
        }

        function updateDiscoveryProgress(text) {
            const el = document.getElementById('discoveryProgress');
            if (el) el.textContent = text;
        }

        // Quick scan (old domains-mapping endpoint)
        async function startQuickScan() {
            thirdPartyLoading = true;
            const resultsEl = document.getElementById('results');

            resultsEl.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p class="loading-text">Quick Scan für "${selectedPageName}"...</p>
                    <p class="loading-subtext">Analysiere Domains und Presell-Chains...</p>
                </div>
            `;

            try {
                const country = document.getElementById('country').value;
                const response = await fetch(`${API_BASE}/domains-mapping`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ brand: selectedPageName, country })
                });

                thirdPartyData = await response.json();
                console.log('Quick scan data:', thirdPartyData);

                if (thirdPartyData.success) {
                    renderThirdPartyContent(thirdPartyData);
                } else {
                    resultsEl.innerHTML = `
                        <div class="error-message">
                            <p><strong>Fehler:</strong> ${thirdPartyData.error}</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Quick scan error:', error);
                resultsEl.innerHTML = `
                    <div class="error-message">
                        <p><strong>Fehler:</strong> ${error.message}</p>
                    </div>
                `;
            } finally {
                thirdPartyLoading = false;
            }
        }

        function renderThirdPartyContent(data) {
            const pages = data.pages || { official: [], third_party: [] };
            const domains = data.domains || { presell: [], final_shop: [], all: [] };
            const domainUrls = data.domain_urls || {};
            const topLandingPages = data.top_landing_pages || [];
            const presellChains = data.presell_chains || [];
            const domainClassifications = data.domain_classifications || [];
            const scanStats = data.scan_stats || null;
            const brandDomain = data.brand_domain || null;
            const brandPlatform = data.brand_platform || null;

            // Count successful presell chains (handle both old and new format)
            const successfulChains = presellChains.filter(c => c.shop_domain || c.cta_url || c.final_domain || c.presell_domain);

            // Build domain → match info lookup from third-party pages
            const domainMatchInfo = {};
            for (const page of pages.third_party) {
                const ct = page.connection_type || '';
                for (const d of (page.domains_used || [])) {
                    if (!domainMatchInfo[d]) {
                        domainMatchInfo[d] = { type: ct, confidence: page.confidence || 0, page: page.page_name };
                    }
                }
            }

            document.getElementById('results').innerHTML = `
                <!-- Brand Info Bar -->
                ${brandDomain ? `
                    <div class="brand-info-bar">
                        <div class="brand-info-left">
                            <span class="brand-domain-label">Brand-Domain:</span>
                            <a href="https://${brandDomain}" target="_blank" class="brand-domain-link">${brandDomain}</a>
                            ${brandPlatform && brandPlatform !== 'unknown' ? `
                                <span class="platform-badge ${brandPlatform}">${brandPlatform}</span>
                            ` : ''}
                        </div>
                        ${scanStats ? `
                            <div class="brand-info-right">
                                <span class="scan-stat">${scanStats.total_ads_scanned?.toLocaleString() || 0} Ads gescannt</span>
                                <span class="scan-stat">${scanStats.unique_domains_checked || 0} Domains geprüft</span>
                                <span class="scan-stat">${scanStats.matches_found || 0} Matches</span>
                                <span class="scan-stat">${scanStats.scan_duration_seconds || 0}s</span>
                            </div>
                        ` : ''}
                        ${data.status === 'cached' ? `<span class="cached-badge" style="cursor:pointer;" onclick="clearDiscoveryCache()" title="Cache löschen und zurück zur Auswahl">CACHED ✕</span>` : ''}
                    </div>
                ` : ''}

                <!-- Stats Overview -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Offizielle Pages</div>
                        <div class="stat-value">${pages.official.length}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Dritt-Pages</div>
                        <div class="stat-value accent">${pages.third_party.length}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">${successfulChains.length > 0 ? 'Presell Chains' : 'Matched Domains'}</div>
                        <div class="stat-value">${successfulChains.length > 0 ? successfulChains.length : (scanStats?.matches_found || 0)}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Shop Domains</div>
                        <div class="stat-value">${domains.final_shop.length}</div>
                    </div>
                </div>

                <!-- Keywords Used (from Discovery) -->
                ${scanStats?.keywords_used?.length > 0 ? `
                    <div class="keywords-bar">
                        <span class="keywords-label">Keywords:</span>
                        ${scanStats.keywords_used.map(k => `<span class="keyword-chip">${k}</span>`).join('')}
                    </div>
                ` : ''}

                <!-- Facebook Pages Section -->
                <h3 class="section-title">
                    <span class="section-title-bar"></span>
                    Facebook Pages für "${data.brand}"
                </h3>
                <div class="pages-grid">
                    ${pages.official.length > 0 ? `
                        <div class="page-category">
                            <div class="category-header">
                                <div class="category-icon official">
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                </div>
                                <span class="category-title">Offizielle Pages</span>
                            </div>
                            ${pages.official.map(page => `
                                <div class="third-party-page-card official">
                                    <div class="tp-page-info">
                                        <span class="tp-page-name">${page.page_name}</span>
                                        <span class="tp-page-id">ID: ${page.page_id}</span>
                                    </div>
                                    <span class="tp-ad-count">${page.ad_count.toLocaleString()} Ads</span>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}

                    ${pages.third_party.length > 0 ? `
                        <div class="page-category">
                            <div class="category-header">
                                <div class="category-icon third-party">
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                                    </svg>
                                </div>
                                <span class="category-title">Drittseiten / Affiliates (${pages.third_party.length})</span>
                            </div>
                            ${pages.third_party.map(page => {
                                const connectionLabels = {
                                    'redirect': 'Redirect',
                                    'redirect_match': 'Redirect',
                                    'shopify_vendor': 'Shopify',
                                    'shopify_vendor_match': 'Shopify',
                                    'checkout_match': 'Checkout',
                                    'presell_cta': 'Presell CTA',
                                    'domain_match': 'Domain',
                                    'content_match': 'Content',
                                    'content_link': 'Link to Brand',
                                    'direct': 'Direct',
                                };
                                const connectionType = page.connection_type || '';
                                const connectionLabel = connectionLabels[connectionType] || connectionType;
                                const confidencePct = page.confidence ? Math.round(page.confidence * 100) : null;
                                const domainsUsed = page.domains_used || [];
                                return `
                                <div class="third-party-page-card third-party">
                                    <div class="tp-page-info">
                                        <div class="tp-page-name-row">
                                            <span class="tp-page-name">${page.page_name}</span>
                                            ${connectionLabel ? `<span class="tp-connection-badge">${connectionLabel}</span>` : ''}
                                            ${confidencePct ? `<span class="tp-confidence">${confidencePct}%</span>` : ''}
                                        </div>
                                        <span class="tp-page-id">ID: ${page.page_id}</span>
                                        ${domainsUsed.length > 0 ? `
                                            <div class="tp-domains-used">
                                                ${domainsUsed.map(d => {
                                                    const urls = domainUrls[d] || [];
                                                    return `
                                                        <div class="tp-domain-block">
                                                            <a href="https://${d}" target="_blank" class="tp-domain-chip">${d}</a>
                                                            ${urls.length > 0 ? `
                                                                <div class="tp-domain-urls">
                                                                    ${urls.slice(0, 3).map(u => `
                                                                        <a href="${u.url}" target="_blank" class="tp-domain-url">${u.url.replace('https://', '').replace('http://', '')}</a>
                                                                    `).join('')}
                                                                </div>
                                                            ` : ''}
                                                        </div>`;
                                                }).join('')}
                                            </div>
                                        ` : ''}
                                    </div>
                                    <span class="tp-ad-count">${page.ad_count.toLocaleString()} Ads</span>
                                </div>`;
                            }).join('')}
                        </div>
                    ` : '<div class="page-category"><p style="color:var(--text-muted);">Keine Drittseiten gefunden. Starte eine Discovery um alle Seiten zu finden.</p></div>'}
                </div>

                <!-- Domains Section -->
                <h3 class="section-title" style="margin-top:40px;">
                    <span class="section-title-bar"></span>
                    Domains nach Kategorie
                </h3>
                <div class="domain-categories">
                    <div class="domain-category">
                        <h4 style="color:var(--accent-warning);">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"/>
                            </svg>
                            Presell / Advertorial Domains
                        </h4>
                        ${domains.presell.length > 0 ? `
                            <div class="domain-list-detailed">
                                ${domains.presell.map(d => {
                                    const urls = domainUrls[d] || [];
                                    const matchInfo = domainMatchInfo[d];
                                    const matchLabels = {
                                        'redirect': 'Redirect', 'redirect_match': 'Redirect',
                                        'shopify_vendor': 'Shopify', 'checkout_match': 'Checkout',
                                        'presell_cta': 'Presell CTA', 'domain_match': 'Domain',
                                        'content_match': 'Content', 'content_link': 'Link',
                                        'direct': 'Direct',
                                    };
                                    return `
                                    <div class="domain-item-block">
                                        <div class="domain-item-header">
                                            <a href="https://${d}" target="_blank" class="domain-chip presell">${d}</a>
                                            ${matchInfo ? `<span class="domain-match-badge">${matchLabels[matchInfo.type] || matchInfo.type} · ${Math.round(matchInfo.confidence * 100)}%</span>` : ''}
                                        </div>
                                        ${urls.length > 0 ? `
                                            <div class="domain-url-list">
                                                ${urls.slice(0, 5).map(u => `
                                                    <a href="${u.url}" target="_blank" class="domain-url-entry">
                                                        <span class="url-path">${u.url.replace('https://', '')}</span>
                                                        <span class="url-ad-count">${u.count}x</span>
                                                    </a>
                                                `).join('')}
                                            </div>
                                        ` : ''}
                                    </div>`;
                                }).join('')}
                            </div>
                        ` : '<p style="color:var(--text-muted);font-size:0.85rem;">Keine Presell Domains gefunden</p>'}
                    </div>

                    ${domains.redirect && domains.redirect.length > 0 ? `
                    <div class="domain-category" style="margin-top:16px;">
                        <h4 style="color:var(--accent-secondary);">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"/>
                            </svg>
                            Redirect Domains
                        </h4>
                        <div class="domain-list-detailed">
                            ${domains.redirect.map(d => {
                                const urls = domainUrls[d] || [];
                                const matchInfo = domainMatchInfo[d];
                                return `
                                <div class="domain-item-block">
                                    <div class="domain-item-header">
                                        <a href="https://${d}" target="_blank" class="domain-chip redirect">${d}</a>
                                        ${matchInfo ? `<span class="domain-match-badge">${Math.round(matchInfo.confidence * 100)}%</span>` : ''}
                                    </div>
                                    ${urls.length > 0 ? `
                                        <div class="domain-url-list">
                                            ${urls.slice(0, 5).map(u => `
                                                <a href="${u.url}" target="_blank" class="domain-url-entry">
                                                    <span class="url-path">${u.url.replace('https://', '')}</span>
                                                    <span class="url-ad-count">${u.count}x</span>
                                                </a>
                                            `).join('')}
                                        </div>
                                    ` : ''}
                                </div>`;
                            }).join('')}
                        </div>
                    </div>
                    ` : ''}

                    <div class="domain-category" style="margin-top:16px;">
                        <h4 style="color:var(--accent-success);">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"/>
                            </svg>
                            Shop / Final Domains
                        </h4>
                        ${domains.final_shop.length > 0 ? `
                            <div class="domain-list-detailed">
                                ${domains.final_shop.map(d => {
                                    const urls = domainUrls[d] || [];
                                    const isBrand = d === brandDomain;
                                    return `
                                    <div class="domain-item-block">
                                        <div class="domain-item-header">
                                            <a href="https://${d}" target="_blank" class="domain-chip shop">${d}</a>
                                            ${isBrand ? '<span class="domain-match-badge brand">Brand</span>' : ''}
                                        </div>
                                        ${urls.length > 0 ? `
                                            <div class="domain-url-list">
                                                ${urls.slice(0, 5).map(u => `
                                                    <a href="${u.url}" target="_blank" class="domain-url-entry">
                                                        <span class="url-path">${u.url.replace('https://', '')}</span>
                                                        <span class="url-ad-count">${u.count}x</span>
                                                    </a>
                                                `).join('')}
                                            </div>
                                        ` : ''}
                                    </div>`;
                                }).join('')}
                            </div>
                        ` : '<p style="color:var(--text-muted);font-size:0.85rem;">Keine Shop Domains gefunden</p>'}
                    </div>
                </div>

                <!-- Presell Chains Section -->
                ${successfulChains.length > 0 ? `
                    <h3 class="section-title" style="margin-top:40px;">
                        <span class="section-title-bar"></span>
                        Presell → Shop Chains
                        <span class="section-count">${successfulChains.length} gefunden</span>
                    </h3>
                    <div class="presell-chains-list">
                        ${successfulChains.slice(0, 10).map(chain => {
                            // Support both old format (initial_url, cta_url, shop_domain) and new format (presell_domain, chain, final_domain)
                            const presellUrl = chain.initial_url || (chain.presell_domain ? `https://${chain.presell_domain}` : '');
                            const presellDomain = chain.presell_domain || extractDomainFromUrl(presellUrl);
                            const shopDomain = chain.shop_domain || chain.final_domain || '';
                            const ctaUrl = chain.cta_url || (chain.chain && chain.chain.length > 1 ? chain.chain[chain.chain.length - 1] : '');
                            const confidence = chain.confidence || 0.8;
                            return `
                            <div class="presell-chain-item">
                                <div class="chain-flow">
                                    <div class="chain-step presell-step">
                                        <span class="step-label">Presell</span>
                                        <a href="${presellUrl || '#'}" target="_blank" class="step-url">${presellDomain}</a>
                                    </div>
                                    ${ctaUrl ? `
                                        <div class="chain-arrow">→</div>
                                        <div class="chain-step cta-step">
                                            <span class="step-label">CTA</span>
                                            <a href="${ctaUrl}" target="_blank" class="step-url">${extractDomainFromUrl(ctaUrl)}</a>
                                        </div>
                                    ` : ''}
                                    ${shopDomain ? `
                                        <div class="chain-arrow">→</div>
                                        <div class="chain-step shop-step">
                                            <span class="step-label">Shop</span>
                                            <span class="step-url shop-domain">${shopDomain}</span>
                                        </div>
                                    ` : ''}
                                </div>
                                <div class="chain-confidence">
                                    <span class="confidence-badge ${confidence >= 0.5 ? 'high' : 'low'}">
                                        ${Math.round(confidence * 100)}% sicher
                                    </span>
                                </div>
                            </div>`;
                        }).join('')}
                    </div>
                ` : ''}

                <!-- Domain Analysis Section -->
                ${domainClassifications.length > 0 ? `
                    <h3 class="section-title" style="margin-top:40px;">
                        <span class="section-title-bar"></span>
                        Domain Analyse
                        <span class="section-count">KI-Klassifizierung</span>
                    </h3>
                    <div class="domain-analysis-grid">
                        ${domainClassifications.filter(d => d.type !== 'unknown').slice(0, 12).map(d => `
                            <div class="domain-analysis-card ${d.type}">
                                <div class="da-domain">${d.domain}</div>
                                <div class="da-type">
                                    <span class="type-badge ${d.type}">${d.type.toUpperCase()}</span>
                                    <span class="da-confidence">${Math.round(d.confidence * 100)}%</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}

                <!-- Top Landing Pages (Full URLs) -->
                <h3 class="section-title" style="margin-top:40px;">
                    <span class="section-title-bar"></span>
                    Top Landing Pages
                </h3>
                ${topLandingPages.length > 0 ? `
                    <div class="landing-pages-table">
                        <div class="lp-header">
                            <span>URL / Domain</span>
                            <span>Ads</span>
                            <span>Leads to</span>
                        </div>
                        ${topLandingPages.slice(0, 20).map((lp, i) => {
                            const fullPath = lp.full_path || '';
                            const hasFullPath = fullPath && fullPath !== '/';
                            const leadsTo = lp.leads_to || '';
                            const method = lp.extraction_method || '';
                            return `
                            <div class="lp-row ${i % 2 === 0 ? 'even' : ''}">
                                <a href="${lp.url}" target="_blank" class="lp-url">
                                    <span class="lp-url-domain">${lp.domain || extractDomainFromUrl(lp.url)}</span>
                                    ${hasFullPath ? `<span class="lp-url-path" title="${fullPath}">${fullPath}</span>` : ''}
                                </a>
                                <span class="lp-count">${lp.count.toLocaleString()}</span>
                                <span class="lp-leads-to">${leadsTo ? `→ ${leadsTo}` : '-'}</span>
                            </div>`;
                        }).join('')}
                    </div>
                ` : '<p style="color:var(--text-muted);">Keine Landing Pages gefunden</p>'}

                <!-- Debug Panel -->
                ${scanStats ? `
                    <div class="debug-panel" style="margin-top:40px;">
                        <div class="debug-toggle" onclick="this.parentElement.classList.toggle('open')" style="
                            cursor:pointer;padding:12px 16px;background:var(--bg-tertiary);border-radius:8px;
                            display:flex;justify-content:space-between;align-items:center;font-size:0.85rem;color:var(--text-secondary);
                        ">
                            <span>Debug Info (Pipeline Details)</span>
                            <span class="debug-arrow" style="transition:transform 0.2s;">▼</span>
                        </div>
                        <div class="debug-content" style="
                            display:none;padding:16px;background:var(--bg-secondary);border:1px solid var(--border);
                            border-radius:0 0 8px 8px;font-family:monospace;font-size:0.8rem;line-height:1.6;
                            max-height:400px;overflow-y:auto;
                        ">
                            <div style="color:var(--text-muted);">
                                <strong>Scan Duration:</strong> ${scanStats.scan_duration_seconds}s<br>
                                <strong>Total Ads Scanned:</strong> ${scanStats.total_ads_scanned?.toLocaleString()}<br>
                                <strong>Unique Domains Checked:</strong> ${scanStats.unique_domains_checked}<br>
                                <strong>Matches Found:</strong> ${scanStats.matches_found}<br>
                                <strong>Match Rate:</strong> ${scanStats.unique_domains_checked > 0 ? Math.round(scanStats.matches_found / scanStats.unique_domains_checked * 100) : 0}%<br>
                                <br>
                                <strong>Detection Methods:</strong><br>
                                ${Object.entries(scanStats.detection_methods || {}).map(([method, count]) =>
                                    `&nbsp;&nbsp;${method}: ${count}`
                                ).join('<br>')}
                                <br><br>
                                <strong>Keywords Used:</strong><br>
                                ${(scanStats.keywords_used || []).map((k, i) =>
                                    `&nbsp;&nbsp;${i+1}. "${k}"`
                                ).join('<br>')}
                                <br><br>
                                <strong>Domain Categories:</strong><br>
                                &nbsp;&nbsp;Presell: ${domains.presell?.length || 0} → ${(domains.presell || []).join(', ') || 'none'}<br>
                                &nbsp;&nbsp;Redirect: ${domains.redirect?.length || 0} → ${(domains.redirect || []).join(', ') || 'none'}<br>
                                &nbsp;&nbsp;Shop: ${domains.final_shop?.length || 0} → ${(domains.final_shop || []).join(', ') || 'none'}<br>
                                <br>
                                <strong>Third-Party Pages:</strong><br>
                                ${pages.third_party.map(p =>
                                    `&nbsp;&nbsp;${p.page_name} (${p.connection_type}, ${Math.round((p.confidence||0)*100)}%) via ${p.discovered_via}`
                                ).join('<br>') || 'none'}
                                <br><br>
                                <strong>Presell Chains:</strong> ${presellChains.length || 0}<br>
                                ${presellChains.map(c =>
                                    `&nbsp;&nbsp;${c.presell_domain || c.initial_url || '?'} → ${c.final_domain || c.shop_domain || '?'}`
                                ).join('<br>') || '&nbsp;&nbsp;none'}
                            </div>
                        </div>
                    </div>
                    <style>
                        .debug-panel.open .debug-content { display: block !important; }
                        .debug-panel.open .debug-arrow { transform: rotate(180deg); }
                    </style>
                ` : ''}
            `;
        }

        function formatNumber(num) {
            if (num >= 1000000000) return (num / 1000000000).toFixed(1) + 'B';
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(0) + 'K';
            return num.toLocaleString();
        }

        function extractDomainFromUrl(url) {
            try {
                const parsed = new URL(url);
                return parsed.hostname.replace('www.', '');
            } catch {
                return url;
            }
        }

        function detectDomainType(domain, url) {
            const d = (domain || '').toLowerCase();
            const u = (url || '').toLowerCase();
            const combined = d + u;

            // Shop indicators
            if (/shopify|myshopify|checkout|warenkorb|cart|shop\.|store\.|buy/i.test(combined)) {
                return 'shop';
            }

            // Presell/editorial indicators
            if (/editorial|review|test|erfahrung|bewertung|ratgeber|artikel|bericht|getestet|vergleich/i.test(combined)) {
                return 'presell';
            }

            // Redirect/tracking indicators
            if (/bit\.ly|tinyurl|redirect|track|link|click|aff|partner/i.test(combined)) {
                return 'redirect';
            }

            return 'shop';
        }

        // Enter key support
        document.getElementById('query').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') searchPages();
        });
    </script>
</body>
</html>
